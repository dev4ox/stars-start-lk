{% extends "base.html" %}
{% load i18n %}

{% block title %}{% trans 'Add order' %}{% endblock %}

{% block content %}
<h2>{% trans "Add Order" %}</h2>
<div class="user-card">
    <img src="{{ service.image_path.url }}" alt="{% trans 'Service' %}">
    <div class="card-body">
        <h5 class="card-title">{{ service.title }}</h5>
        <p class="card-text">{{ service.description }}</p>
    </div>
    <div class="card-order-info">
        <form method="post">
            {% csrf_token %}
            {{ form.as_p }}
            <div class="order-price">
            <label>{% trans "Discount" %}:</label><p id="promo_code_discount_text"></p>
            <label>{% trans "Cost" %}:</label><p id="category_cost_text"></p>
            <button class="btn-primary" type="submit">{% trans "Submit" %}</button>
            </div>
        </form>
    </div>
</div>

{% endblock %}
{% block scripts %}
<script>
    document.addEventListener("DOMContentLoaded", function() {
        var serviceSelect = document.getElementById('id_service');
        var categorySelect = document.getElementById('id_category');
        var promoCodeInput = document.getElementById('id_promo_code');
        var csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        var costText = document.getElementById('category_cost_text');
        var discountText = document.getElementById('promo_code_discount_text');

        function loadCategoryCost(category_id) {
            fetch('/ajax/get-category-cost/?category=' + category_id, {
                method: 'GET',
                headers: {
                    'X-CSRFToken': csrfToken
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.cost == 0) {
                    costText.textContent = '{% trans "Negotiable" %}';
                }
                else {
                    costText.textContent = data.cost + ' â‚½';
                };
            });
        }

        function loadPromoCodeDiscount(promo_code) {
            fetch('/ajax/check-promo-code/?promo_code=' + promo_code, {
                method: 'GET',
                headers: {
                    'X-CSRFToken': csrfToken
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.is_valid) {
                    discountText.textContent = data.discount + ' %';
                } else {
                    discountText.textContent = '{% trans "Invalid promo code" %}';
                }
            });
        }

        if (categorySelect.value) {
            loadCategoryCost(categorySelect.value);
        }

        categorySelect.addEventListener('change', function() {
            loadCategoryCost(this.value);
        });

        promoCodeInput.addEventListener('input', function() {
            loadPromoCodeDiscount(this.value);
        });
    });
</script>
{% endblock %}
